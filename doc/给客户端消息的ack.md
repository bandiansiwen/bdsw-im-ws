# 给客户端消息的ack

这是一个非常关键的设计决策点，直接影响到用户体验的流畅度和消息的可靠性。在大型IM平台的分层架构中，ACK的时机是分层、分场景的，绝非单一节点。

核心原则是：在保证消息“不丢失”的最小可靠前提下，尽可能早地ACK，让用户感觉流畅。

下面这张流程图清晰地展示了三种不同可靠性等级的ACK策略及其触发时机，你可以根据消息的重要性进行选择：

![ack给客户端.png](pic/ack%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF.png)

## 三种ACK策略详解与选择

### 策略一：快速ACK（写入即成功）

- 时机：在逻辑网关/接入层将消息成功写入RocketMQ后（SendResult.SEND_OK），立即回复ACK给客户端。
- 流程：客户端 → 接入网关 → 逻辑网关 → 写入MQ成功 → ACK → (异步)业务消费 → 投递给接收方。
- 优点：用户体验极佳，发送消息后立即出现“已发送”状态，无延迟感。
- 缺点：存在极小概率的消息丢失风险（如写入MQ后但Broker在刷盘前宕机，且未开启同步刷盘）。业务层后续处理失败（如接收方ID非法），客户端也无从知晓。
- 适用场景：绝大多数普通聊天消息（如微信/钉钉的普通文本、表情）。用极低的风险换取最好的体验，即使有十万分之一的丢失，在聊天场景中也可接受。

### 策略二：可靠ACK（逻辑校验成功）

- 时机：核心业务服务（如msg服务）消费MQ消息，并完成最关键的业务逻辑校验（如发送者权限、接收者存在性、关系链校验）后，再通知网关层ACK客户端。
- 流程：客户端 → 接入网关 → 逻辑网关 → 写入MQ → 业务层消费并校验成功 → 反向通知 → ACK → (异步)投递。
- 优点：保证了消息的业务有效性，无效消息不会让用户产生“已发送”的误解。
- 缺点：链路长，延迟增加，架构复杂（需要业务层反向通知机制）。
- 适用场景：重要的系统通知、入群邀请、文件传输发起等需要确保业务逻辑正确的消息。

### 策略三：强一致ACK（落地即成功）

- 时机：接收方客户端成功接收并持久化后，才ACK给发送方。这通常需要接收方回传一个业务层的ACK。
- 流程：发送方 → ... → 接收方 → 接收方持久化消息 → 发送业务ACK → 回传至发送方网关 → ACK给发送方。
- 优点：可靠性最高，发送方明确知道对方已收到。
- 缺点：延迟非常高，且依赖接收方在线和网络状况。
- 适用场景：支付凭证、法律合约等需要收据的关键消息。在普通聊天中，这就是“已读回执”功能，是用户主动触发的，而非默认行为。

## 大型平台的混合实践

微信、钉钉实际上混合使用了以上策略：

- 默认快速ACK：你发出一条消息，瞬间出现“✓”（已发送），这对应策略一。此时消息刚离开你的手机，进入腾讯/阿里的服务器队列。
- 关键操作可靠ACK：你发送一个大文件，会先显示“发送中…”，直到服务器完成文件切片存储等关键操作后，才变为“✓”，这对应策略二。
- 增值功能的强一致ACK：你开启了“已读回执”功能的会话，你的“✓”会在他人的设备真正点开消息后，变成“已读”，这对应策略三。
































