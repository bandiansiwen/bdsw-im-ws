# IM网关设计

在微信、钉钉这类亿级用户的大型IM平台中，网关（WebSocket服务）在收到客户端消息后，绝大多数情况下既不会直接投递RocketMQ，也不会直接调用下游复杂的msg业务服务，而是会调用一个极简的、专用的“接入层”或“协议层”服务，由这个服务负责与后端的消息队列（不一定是RocketMQ）和复杂业务解耦。

## 大型IM平台的典型架构分层

### 第一层：纯接入网关

- 职责：只管理TCP/WebSocket长连接，处理网络字节流的拆包粘包、心跳、加密解密、压缩解压缩。它不解析业务报文。
- 行为：收到客户端二进制包后，完成解码，可能只做一个最简单的动作：将这个二进制包或一个极简的结构体（包含连接ID和原始数据）通过内部高速RPC（如gRPC）或共享内存，发送给第二层的“逻辑网关”。它完全不知道RocketMQ的存在。

### 第二层：逻辑网关/接入服务

- 职责：这是关键的一层。它负责：
  - 协议解析：将原始数据解析为具体的业务指令（如 发送消息、加入群组）。
  - 基础验证：检查消息格式、长度、频率限制（反垃圾）、Token有效性等轻量级业务逻辑。
  - 路由准备：查询或绑定消息发送者的路由信息。

- 行为：验证通过后，它才会构造一个结构化的、干净的内部请求对象，发送到后端的消息队列（如RocketMQ）。这个请求对象已经是业务服务能直接理解的“普通话”。

### 第三层：核心业务服务

- 职责：消费消息队列里的结构化请求，执行重量级业务逻辑，如写入消息库、同步群聊、关系链检查、推送通知等。

- 行为：msg服务在这里，它从RocketMQ消费，处理完后，如果需要下行通知，会再次写入另一条消息队列。

## 为什么不是“直接投递MQ”或“直接调用msg服务”？

- 为什么不直接投递MQ？
  - 安全与风控：MQ不适合做复杂、快速变更的风控策略（如敏感词过滤、刷屏检测）。这些需要在请求进入队列前拦截。
  - 协议与耦合：让MQ承载原始的、多变的客户端协议，会使生产者和消费者耦合过紧。协议升级需要上下游同时改动。
  - 资源浪费：无效或恶意请求会污染MQ，浪费存储和带宽。


- 为什么不直接调用msg服务？
  - 容量与耦合：海量网关直接连接业务服务，会使业务服务暴露在巨大的连接和并发压力下，难以独立扩容。一个业务服务故障会直接影响所有用户的连接。
  - 可靠性：RPC调用是同步的，容易因业务服务抖动导致网关级联故障。而MQ提供了天然的异步化、削峰填谷、故障隔离的能力。
  - 架构清晰：通过MQ解耦，业务服务可以独立部署、升级、扩容，技术栈也可以与网关层不同。





















